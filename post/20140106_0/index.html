
<!DOCTYPE html>
<html lang="ja">
<head>

  
  <meta charset="UTF-8">
  <title>
    【Android】NDK から OpenCV を使うプロジェクトを作る手順 | ZABURO app
  </title>

  
  <meta name="twitter:card" content="summary" />
  <meta name="og:title" content="【Android】NDK から OpenCV を使うプロジェクトを作る手順" />
  <meta name="og:description" content="久しぶりにAndroidでOpenCVを使おうとしたら
書き始めるまでに必要な準備を忘れていたのでメモ。
コメントを書き入れている部分は
「ここにかかなければいけない、というわけではないけど
ここに書いておくのが便利」という部分です
環境 Eclipse 3.7.2
・「プロパティ」→「Android」からOpenCVのライブラリを登録
・OpenCVを使うActivityのメンバに以下を追加し
private BaseLoaderCallback mLoaderCallback = new BaseLoaderCallback(this) { @Override public void onManagerConnected(int status) { switch (status) { case LoaderCallbackInterface.SUCCESS: //ここで後で自分で作成するC/C&#43;&#43;でopencvを動かすライブラリをロードしておく System.loadLibrary(&ldquo;my_opencv_method&rdquo;); //ロードが成功した場合にのみボタンを有効にする mButton.setEnabled(true); break; default: super.onManagerConnected(status); break; } } };onResumeを以下のようにオーバーライド
@Override public void onResume() { super.onResume(); //ボタンはロード成功するまでは無効化しておく mButton1.setEnabled(false); OpenCVLoader.initAsync(OpenCVLoader.OPENCV_VERSION_2_4_3, this, mLoaderCallback); }・プロジェクトを右クリック→「Android ツール」→「Add native support」
・プロジェクトを右クリック→「プロパティ」→「C/C&#43;&#43;一般」→「パスおよびシンボル」→「インクルード」タブ→「追加」ボタン
で最低でも以下の３つを登録
/opt/OpenCV-2.4.6-android-sdk/sdk/native/jni/include
/opt/android-ndk-r9/sources/cxx-stl/gnu-libstdc&#43;&#43;/4.6/include
/opt/android-ndk-r9/sources/cxx-stl/gnu-libstdc&#43;&#43;/4.6/libs/armeabi-v7a/include
(僕は/optに各ライブラリを置いているのでそのへんは適宜修正)
・jniフォルダを作成して、Android.mkとApplication.mkを用意
(他のプロジェクトからコピペして編集)
Android.mk
LOCAL_PATH := $(call my-dir) include $(CLEAR_VARS) #OPENCV_CAMERA_MODULES:=off #OPENCV_INSTALL_MODULES:=off #OPENCV_LIB_TYPE:=SHARED include /opt/OpenCV-2." />
  <meta name="twitter:url" content="https://zaburo-ch.github.io/post/20140106_0/" />
  <meta name="twitter:site" content="@musharna000" />


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">


  
  <link rel="stylesheet" href="/css/sanitize.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/highlight_monokai.css">
  
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/theme.css">


  
  


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="/">ZABURO app</a></h1>
        <h2>アプリ作ったり、なんやかんや</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="/about/">About</a></li>
          <li><a href="/product/">Product</a></li>
          
          
          <li><a href="https://github.com/zaburo-ch" target="_blank">GitHub</a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>【Android】NDK から OpenCV を使うプロジェクトを作る手順</h1>
      <div class="meta">
        Jan 6, 2014 &nbsp;
        
      </div>
    </div>
    <article>
      <p>久しぶりにAndroidでOpenCVを使おうとしたら<br />
書き始めるまでに必要な準備を忘れていたのでメモ。<br />
コメントを書き入れている部分は<br />
「ここにかかなければいけない、というわけではないけど<br />
ここに書いておくのが便利」という部分です</p>

<p>環境 Eclipse 3.7.2</p>

<p>・「プロパティ」→「Android」からOpenCVのライブラリを登録</p>

<p>・OpenCVを使うActivityのメンバに以下を追加し<br />
<pre><code>private BaseLoaderCallback mLoaderCallback = new BaseLoaderCallback(this) {
    @Override
    public void onManagerConnected(int status) {
        switch (status) {
        case LoaderCallbackInterface.SUCCESS:
            //ここで後で自分で作成するC/C++でopencvを動かすライブラリをロードしておく
            System.loadLibrary(&ldquo;my_opencv_method&rdquo;);
            //ロードが成功した場合にのみボタンを有効にする
            mButton.setEnabled(true);
            break;
        default:
            super.onManagerConnected(status);
            break;
        }
    }
};</code></pre>onResumeを以下のようにオーバーライド<br />
<pre><code>@Override
public void onResume()
{
    super.onResume();
    //ボタンはロード成功するまでは無効化しておく
    mButton1.setEnabled(false);
    OpenCVLoader.initAsync(OpenCVLoader.OPENCV_VERSION_2_4_3, this, mLoaderCallback);
}</code></pre>・プロジェクトを右クリック→「Android ツール」→「Add native support」</p>

<p>・プロジェクトを右クリック→「プロパティ」→「C/C++一般」→「パスおよびシンボル」→「インクルード」タブ→「追加」ボタン<br />
で最低でも以下の３つを登録<br />
/opt/OpenCV-2.4.6-android-sdk/sdk/native/jni/include<br />
/opt/android-ndk-r9/sources/cxx-stl/gnu-libstdc++/4.6/include<br />
/opt/android-ndk-r9/sources/cxx-stl/gnu-libstdc++/4.6/libs/armeabi-v7a/include<br />
(僕は/optに各ライブラリを置いているのでそのへんは適宜修正)</p>

<p>・jniフォルダを作成して、Android.mkとApplication.mkを用意<br />
(他のプロジェクトからコピペして編集)<br />
Android.mk<br />
<pre><code>LOCAL_PATH := $(call my-dir)
include $(CLEAR_VARS)
#OPENCV_CAMERA_MODULES:=off
#OPENCV_INSTALL_MODULES:=off
#OPENCV_LIB_TYPE:=SHARED
include /opt/OpenCV-2.4.6-android-sdk/sdk/native/jni/OpenCV.mk
LOCAL_SRC_FILES  := my_opencv_method.cpp
LOCAL_C_INCLUDES += $(LOCAL_PATH)
LOCAL_LDLIBS     += -llog -ldl
LOCAL_MODULE     := my_opencv_method
include $(BUILD_SHARED_LIBRARY)
</pre></code>
Application.mk<br />
<pre><code>APP_STL := gnustl_static
APP_CPPFLAGS := -frtti -fexceptions
APP_ABI := armeabi-v7a
APP_PLATFORM := android-8</code></pre><br />
・Activityにnativeメソッドを記載<br />
例<br />
<pre><code>public static native void threshold(long matAddr);
public static native int[] findContours(long matAddr);</code></pre><br />
・プロジェクトのAndroidManifest.xmlなどが保存してあるディレクトリに移動し以下のコマンドを実行<br />
<pre><code>javah -classpath src -o jni/my_opencv_method.h {package name}.MainActivity</code></pre>jniにmy_opencv_method.hが生成される</p>

<p>・my_opencv_method.hからメソッドをコピー<br />
<pre><code>JNIEXPORT void JNICALL Java_com_fc2_blog_zaburoapp_markerdetection_MainActivity_threshold (JNIEnv *, jclass, jlong);</code></pre></p>

<p>・my_opencv_method.cppを作成してペーストし、以下のincludeを加える<br />
<pre><code>#include &lt;jni.h&gt;
#include &lt;vector&gt;
#include &lt;opencv2/core/core.hpp&gt;
#include &lt;opencv2/imgproc/imgproc.hpp&gt;
#include &lt;opencv2/objdetect/objdetect.hpp&gt;
#include &lt;opencv2/highgui/highgui.hpp&gt;
#include &lt;opencv2/calib3d/calib3d.hpp&gt;
#include &lt;android/log.h&gt;
#include &lt;my_opencv_method.h&gt;
</code></pre>このへんがあれば十分<br />
(JNIEnv *, jclass, jlong)→(JNIEnv * jenv, jclass, jlong matAddr)みたいな感じで<br />
変数名を指定するのを忘れずに。</p>

<p>・コードを書いて実行</p>

    </article>

    
    <div style="margin: 60px 0 10px;">
      <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-normal" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
      <a href="https://twitter.com/share" class="twitter-share-button" data-via="musharna000">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </div>
    
    
  </main>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      
      Written by ZABURO
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



</body>
</html>

